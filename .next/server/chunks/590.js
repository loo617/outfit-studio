"use strict";exports.id=590,exports.ids=[590],exports.modules={9303:(e,t,s)=>{e.exports=s(517)},8697:(e,t,s)=>{s.d(t,{KU:()=>el});var n,i=Object.defineProperty,a=(e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,r=(e,t,s)=>(a(e,"symbol"!=typeof t?t+"":t,s),s),o=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},l=(e,t,s)=>(o(e,t,"read from private field"),s?s.call(e):t.get(e)),c=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},u=(e,t,s,n)=>(o(e,t,"write to private field"),n?n.call(e,s):t.set(e,s),s),d=new Intl.Collator(0,{numeric:1}).compare;function p(e,t,s){return e=e.split("."),t=t.split("."),d(e[0],t[0])||d(e[1],t[1])||(t[2]=t.slice(2).join("."),(s=/[.-]/.test(e[2]=e.slice(2).join(".")))==/[.-]/.test(t[2])?d(e[2],t[2]):s?-1:1)}let h="upload",f="This application is currently busy. Please try again. ",g="Connection errored out. ",m="Could not resolve app config. ",w="Space metadata could not be loaded. ",_="Invalid credentials. Could not login. ",y="Root URL not found in client config";function v(e,t,s){return t.startsWith("http://")||t.startsWith("https://")?s?e:t:e+t}async function b(e,t,s){try{let n=await fetch(`https://huggingface.co/api/spaces/${e}/jwt`,{headers:{Authorization:`Bearer ${t}`,...s?{Cookie:s}:{}}});return(await n.json()).token||!1}catch(e){return!1}}async function E(e){var t;let s=this.options.hf_token?{Authorization:`Bearer ${this.options.hf_token}`}:{};if(s["Content-Type"]="application/json","undefined"!=typeof window&&window.gradio_config&&"http://localhost:9876"!==location.origin&&!window.gradio_config.dev_mode){let t=window.gradio_config.root,s=window.gradio_config,n=v(e,s.root,!1);return s.root=n,{...s,path:t}}if(e){let n=P(e,"config"),i=await this.fetch(n,{headers:s,credentials:"include"});if((null==i?void 0:i.status)!==401||this.options.auth){if((null==i?void 0:i.status)===401&&this.options.auth)throw Error(_)}else throw Error("Login credentials are required to access this space.");if((null==i?void 0:i.status)===200){let s=await i.json();return s.path=s.path??"",s.root=e,null==(t=s.dependencies)||t.forEach((e,t)=>{void 0===e.id&&(e.id=t)}),s}if((null==i?void 0:i.status)===401)throw Error("Not authorized to access this space. ")}throw Error(m)}async function S(){let{http_protocol:e,host:t}=await D(this.app_reference,this.options.hf_token);try{if(this.options.auth){let s=await $(e,t,this.options.auth,this.fetch,this.options.hf_token);s&&this.set_cookies(s)}}catch(e){throw Error(e.message)}}async function $(e,t,s,n,i){let a=new FormData;a.append("username",null==s?void 0:s[0]),a.append("password",null==s?void 0:s[1]);let r={};i&&(r.Authorization=`Bearer ${i}`);let o=await n(`${e}//${t}/login`,{headers:r,method:"POST",body:a,credentials:"include"});if(200===o.status)return o.headers.get("set-cookie");if(401===o.status)throw Error(_);throw Error(w)}function k(e){if(e.startsWith("http")){let{protocol:t,host:s,pathname:n}=new URL(e);return s.endsWith("hf.space")?{ws_protocol:"wss",host:s,http_protocol:t}:{ws_protocol:"https:"===t?"wss":"ws",http_protocol:t,host:s+("/"!==n?n:"")}}return e.startsWith("file:")?{ws_protocol:"ws",http_protocol:"http:",host:"lite.local"}:{ws_protocol:"wss",http_protocol:"https:",host:e}}let j=e=>{let t=[];return e.split(/,(?=\s*[^\s=;]+=[^\s=;]+)/).forEach(e=>{let[s,n]=e.split(";")[0].split("=");s&&n&&t.push(`${s.trim()}=${n.trim()}`)}),t},O=/^[a-zA-Z0-9_\-\.]+\/[a-zA-Z0-9_\-\.]+$/,T=/.*hf\.space\/{0,1}$/;async function D(e,t){let s={};t&&(s.Authorization=`Bearer ${t}`);let n=e.trim().replace(/\/$/,"");if(O.test(n))try{let t=await fetch(`https://huggingface.co/api/spaces/${n}/host`,{headers:s}),i=(await t.json()).host;return{space_id:e,...k(i)}}catch(e){throw Error(w)}if(T.test(n)){let{ws_protocol:e,http_protocol:t,host:s}=k(n);return{space_id:s.replace(".hf.space",""),ws_protocol:e,http_protocol:t,host:s}}return{space_id:!1,...k(n)}}let P=(...e)=>{try{return e.reduce((e,t)=>(e=e.replace(/\/+$/,""),t=t.replace(/^\/+/,""),new URL(t,e+"/").toString()))}catch(e){throw Error("Invalid URL. A full URL path is required.")}};function q(e,t){switch(e.msg){case"send_data":return{type:"data"};case"send_hash":return{type:"hash"};case"queue_full":return{type:"update",status:{queue:!0,message:f,stage:"error",code:e.code,success:e.success}};case"heartbeat":return{type:"heartbeat"};case"unexpected_error":return{type:"unexpected_error",status:{queue:!0,message:e.message,stage:"error",success:!1}};case"estimation":return{type:"update",status:{queue:!0,stage:t||"pending",code:e.code,size:e.queue_size,position:e.rank,eta:e.rank_eta,success:e.success}};case"progress":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,progress_data:e.progress_data,success:e.success}};case"log":return{type:"log",data:e};case"process_generating":return{type:"generating",status:{queue:!0,message:e.success?null:e.output.error,stage:e.success?"generating":"error",code:e.code,progress_data:e.progress_data,eta:e.average_duration},data:e.success?e.output:null};case"process_completed":if("error"in e.output)return{type:"update",status:{queue:!0,message:e.output.error,visible:e.output.visible,duration:e.output.duration,stage:"error",code:e.code,success:e.success}};return{type:"complete",status:{queue:!0,message:e.success?void 0:e.output.error,stage:e.success?"complete":"error",code:e.code,progress_data:e.progress_data,changed_state_ids:e.success?e.output.changed_state_ids:void 0},data:e.success?e.output:null};case"process_starts":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,size:e.rank,position:0,success:e.success,eta:e.eta}}}return{type:"none",status:{stage:"error",queue:!0}}}let C=(e=[],t)=>{let s=t?t.parameters:[];if(Array.isArray(e))return e.length>s.length&&console.warn("Too many arguments provided for the endpoint."),e;let n=[],i=Object.keys(e);return s.forEach((t,s)=>{if(e.hasOwnProperty(t.parameter_name))n[s]=e[t.parameter_name];else if(t.parameter_has_default)n[s]=t.parameter_default;else throw Error(`No value provided for required parameter: ${t.parameter_name}`)}),i.forEach(e=>{if(!s.some(t=>t.parameter_name===e))throw Error(`Parameter \`${e}\` is not a valid keyword argument. Please refer to the API for usage.`)}),n.forEach((e,t)=>{if(void 0===e&&!s[t].parameter_has_default)throw Error(`No value provided for required parameter: ${s[t].parameter_name}`)}),n};async function N(){if(this.api_info)return this.api_info;let{hf_token:e}=this.options,{config:t}=this,s={"Content-Type":"application/json"};if(e&&(s.Authorization=`Bearer ${e}`),t)try{let e,n;if("undefined"!=typeof window&&window.gradio_api_info)n=window.gradio_api_info;else{if(0>p((null==t?void 0:t.version)||"2.0.0","3.30"))e=await this.fetch("https://gradio-space-api-fetcher-v2.hf.space/api",{method:"POST",body:JSON.stringify({serialize:!1,config:JSON.stringify(t)}),headers:s,credentials:"include"});else{let n=P(t.root,"info");e=await this.fetch(n,{headers:s,credentials:"include"})}if(!e.ok)throw Error(g);n=await e.json()}return"api"in n&&(n=n.api),n.named_endpoints["/predict"]&&!n.unnamed_endpoints["0"]&&(n.unnamed_endpoints[0]=n.named_endpoints["/predict"]),function(e,t,s){let n={named_endpoints:{},unnamed_endpoints:{}};return Object.keys(e).forEach(i=>{("named_endpoints"===i||"unnamed_endpoints"===i)&&(n[i]={},Object.entries(e[i]).forEach(([e,{parameters:a,returns:r}])=>{var o,l,c,u;let d=(null==(o=t.dependencies.find(t=>t.api_name===e||t.api_name===e.replace("/","")))?void 0:o.id)||s[e.replace("/","")]||-1,p=-1!==d?null==(l=t.dependencies.find(e=>e.id==d))?void 0:l.types:{generator:!1,cancel:!1};if(-1!==d&&(null==(u=null==(c=t.dependencies.find(e=>e.id==d))?void 0:c.inputs)?void 0:u.length)!==a.length){let e=t.dependencies.find(e=>e.id==d).inputs.map(e=>{var s;return null==(s=t.components.find(t=>t.id===e))?void 0:s.type});try{e.forEach((e,t)=>{"state"===e&&a.splice(t,0,{component:"state",example:null,parameter_default:null,parameter_has_default:!0,parameter_name:null,hidden:!0})})}catch(e){console.error(e)}}let h=(e,t,s,n)=>{var i;return{...e,description:(i=null==e?void 0:e.type,"GallerySerializable"===s?"array of [file, label] tuples":"ListStringSerializable"===s?"array of strings":"FileSerializable"===s?"array of files or single file":null==i?void 0:i.description),type:function(e,t,s,n){switch(null==e?void 0:e.type){case"string":return"string";case"boolean":return"boolean";case"number":return"number"}return"JSONSerializable"===s||"StringSerializable"===s?"any":"ListStringSerializable"===s?"string[]":"Image"===t?"parameter"===n?"Blob | File | Buffer":"string":"FileSerializable"===s?(null==e?void 0:e.type)==="array"?"parameter"===n?"(Blob | File | Buffer)[]":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}[]":"parameter"===n?"Blob | File | Buffer":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}":"GallerySerializable"===s?"parameter"===n?"[(Blob | File | Buffer), (string | null)][]":"[{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}, (string | null))][]":void 0}(null==e?void 0:e.type,t,s,n)||""}};n[i][e]={parameters:a.map(e=>h(e,null==e?void 0:e.component,null==e?void 0:e.serializer,"parameter")),returns:r.map(e=>h(e,null==e?void 0:e.component,null==e?void 0:e.serializer,"return")),type:p}}))}),n}(n,t,this.api_map)}catch(e){e.message}}async function z(e,t,s){var n;let i;let a={};(null==(n=this==null?void 0:this.options)?void 0:n.hf_token)&&(a.Authorization=`Bearer ${this.options.hf_token}`);let r=[];for(let n=0;n<t.length;n+=1e3){let o=t.slice(n,n+1e3),l=new FormData;o.forEach(e=>{l.append("files",e)});try{let t=s?`${e}/${h}?upload_id=${s}`:`${e}/${h}`;i=await this.fetch(t,{method:"POST",body:l,headers:a,credentials:"include"})}catch(e){throw Error(g+e.message)}if(!i.ok){let e=await i.text();return{error:`HTTP ${i.status}: ${e}`}}let c=await i.json();c&&r.push(...c)}return{files:r}}async function A(e,t,s,n){let i=(Array.isArray(e)?e:[e]).map(e=>e.blob),a=i.filter(e=>e.size>(n??1/0));if(a.length)throw Error(`File size exceeds the maximum allowed size of ${n} bytes: ${a.map(e=>e.name).join(", ")}`);return await Promise.all(await this.upload_files(t,i,s).then(async s=>{if(s.error)throw Error(s.error);return s.files?s.files.map((s,n)=>new x({...e[n],path:s,url:t+"/file="+s})):[]}))}class x{constructor({path:e,url:t,orig_name:s,size:n,blob:i,is_stream:a,mime_type:o,alt_text:l}){r(this,"path"),r(this,"url"),r(this,"orig_name"),r(this,"size"),r(this,"blob"),r(this,"is_stream"),r(this,"mime_type"),r(this,"alt_text"),r(this,"meta",{_type:"gradio.FileData"}),this.path=e,this.url=t,this.orig_name=s,this.size=n,this.blob=t?void 0:i,this.is_stream=a,this.mime_type=o,this.alt_text=l}}class B{constructor(e,t){r(this,"type"),r(this,"command"),r(this,"meta"),r(this,"fileData"),this.type="command",this.command=e,this.meta=t}}function L(e,t,s){for(;s.length>1;){let t=s.shift();if("string"==typeof t||"number"==typeof t)e=e[t];else throw Error("Invalid key type")}let n=s.shift();if("string"==typeof n||"number"==typeof n)e[n]=t;else throw Error("Invalid key type")}async function U(e,t,s=[],n=!1,i){if(Array.isArray(e)){let a=[];return await Promise.all(e.map(async(r,o)=>{var l;let c=s.slice();c.push(String(o));let u=await U(e[o],n?(null==(l=null==i?void 0:i.parameters[o])?void 0:l.component)||void 0:t,c,!1,i);a=a.concat(u)})),a}if(globalThis.Buffer&&e instanceof globalThis.Buffer||e instanceof Blob)return[{path:s,blob:new Blob([e]),type:t}];if("object"==typeof e&&null!==e){let t=[];for(let n of Object.keys(e)){let a=[...s,n],r=e[n];t=t.concat(await U(r,void 0,a,!1,i))}return t}return[]}function I(e,t,s,n,i=!1){if("input"===n&&!i)throw Error("Invalid code path. Cannot skip state inputs for input.");if("output"===n&&i)return e;let a=[],r=0,o="input"===n?t.inputs:t.outputs;for(let t=0;t<o.length;t++){let n=o[t],l=s.find(e=>e.id===n);if((null==l?void 0:l.type)==="state"){if(i){if(e.length===o.length){let t=e[r];a.push(t),r++}else a.push(null)}else r++;continue}{let t=e[r];a.push(t),r++}}return a}async function R(e,t,s){let n=this;await F(n,t);let i=await U(t,void 0,[],!0,s);return(await Promise.all(i.map(async({path:t,blob:s,type:i})=>{if(!s)return{path:t,type:i};let a=await n.upload_files(e,[s]);return{path:t,file_url:a.files&&a.files[0],type:i,name:"undefined"!=typeof File&&s instanceof File?null==s?void 0:s.name:void 0}}))).forEach(({path:e,file_url:s,type:n,name:i})=>{"Gallery"===n?L(t,s,e):s&&L(t,new x({path:s,orig_name:i}),e)}),t}async function F(e,t){var s,n;if(!((null==(s=e.config)?void 0:s.root)||(null==(n=e.config)?void 0:n.root_url)))throw Error(y);await J(e,t)}async function J(e,t,s=[]){for(let n in t)t[n]instanceof B?await W(e,t,n):"object"==typeof t[n]&&null!==t[n]&&await J(e,t[n],[...s,n])}async function W(e,t,n){var i,a;let r=t[n],o=(null==(i=e.config)?void 0:i.root)||(null==(a=e.config)?void 0:a.root_url);if(!o)throw Error(y);try{let i,a;if("undefined"!=typeof process&&process.versions&&process.versions.node){let e=await Promise.resolve().then(s.t.bind(s,3292,19));a=(await Promise.resolve().then(s.t.bind(s,1017,19))).resolve(process.cwd(),r.meta.path),i=await e.readFile(a)}else throw Error("File system access is only available in Node.js environments");let l=new Blob([i],{type:"application/octet-stream"}),c=await e.upload_files(o,[l]),u=c.files&&c.files[0];if(u){let e=new x({path:u,orig_name:r.meta.name||""});t[n]=e}}catch(e){console.error("Error uploading file",e)}}async function G(e,t,s){let n,i;let a={"Content-Type":"application/json"};this.options.hf_token&&(a.Authorization=`Bearer ${this.options.hf_token}`);try{var r=await this.fetch(e,{method:"POST",body:JSON.stringify(t),headers:{...a,...s},credentials:"include"})}catch(e){return[{error:g},500]}try{n=await r.json(),i=r.status}catch(e){n={error:`Could not parse server response: ${e}`},i=500}return[n,i]}async function M(e,t={}){let s=!1,n=!1;if(!this.config)throw Error("Could not resolve app config");if("number"==typeof e)this.config.dependencies.find(t=>t.id==e);else{let t=e.replace(/^\//,"");this.config.dependencies.find(e=>e.id==this.api_map[t])}return new Promise(async(i,a)=>{let r;for await(let o of this.submit(e,t,null,null,!0))"data"===o.type&&(n&&i(r),s=!0,r=o),"status"===o.type&&("error"===o.stage&&a(o),"complete"===o.stage&&(n=!0,s&&i(r)))})}async function H(e,t,s){let n,i,a="subdomain"===t?`https://huggingface.co/api/spaces/by-subdomain/${e}`:`https://huggingface.co/api/spaces/${e}`;try{if(i=(n=await fetch(a)).status,200!==i)throw Error();n=await n.json()}catch(e){s({status:"error",load_status:"error",message:"Could not get space status. ",detail:"NOT_FOUND"});return}if(!n||200!==i)return;let{runtime:{stage:r},id:o}=n;switch(r){case"STOPPED":case"SLEEPING":s({status:"sleeping",load_status:"pending",message:"Space is asleep. Waking it up...",detail:r}),setTimeout(()=>{H(e,t,s)},1e3);break;case"PAUSED":s({status:"paused",load_status:"error",message:"This space has been paused by the author. If you would like to try this demo, consider duplicating the space.",detail:r,discussions_enabled:await V(o)});break;case"RUNNING":case"RUNNING_BUILDING":s({status:"running",load_status:"complete",message:"Space is running.",detail:r});break;case"BUILDING":s({status:"building",load_status:"pending",message:"Space is building...",detail:r}),setTimeout(()=>{H(e,t,s)},1e3);break;case"APP_STARTING":s({status:"starting",load_status:"pending",message:"Space is starting...",detail:r}),setTimeout(()=>{H(e,t,s)},1e3);break;default:s({status:"space_error",load_status:"error",message:"This space is experiencing an issue.",detail:r,discussions_enabled:await V(o)})}}"undefined"!=typeof process&&process.versions&&process.versions.node;let K=async(e,t)=>{let s=0;return new Promise(n=>{H(e,O.test(e)?"space_name":"subdomain",i=>{t(i),"running"===i.status?n():"error"===i.status||"paused"===i.status||"space_error"===i.status?n():("sleeping"===i.status||"building"===i.status)&&(s<12?(s++,setTimeout(()=>{K(e,t).then(n)},5e3)):n())})})},Z=/^(?=[^]*\b[dD]iscussions{0,1}\b)(?=[^]*\b[dD]isabled\b)[^]*$/;async function V(e){try{let t=await fetch(`https://huggingface.co/api/spaces/${e}/discussions`,{method:"HEAD"}),s=t.headers.get("x-error-message");if(!t.ok||s&&Z.test(s))return!1;return!0}catch(e){return!1}}async function Q(e,t){let s={};t&&(s.Authorization=`Bearer ${t}`);try{let t=await fetch(`https://huggingface.co/api/spaces/${e}/runtime`,{headers:s});if(200!==t.status)throw Error("Space hardware could not be obtained.");let{hardware:n}=await t.json();return n.current}catch(e){throw Error(e.message)}}async function X(e,t,s){let n={};s&&(n.Authorization=`Bearer ${s}`);try{let s=await fetch(`https://huggingface.co/api/spaces/${e}/sleeptime`,{method:"POST",headers:{"Content-Type":"application/json",...n},body:JSON.stringify({seconds:t})});if(200!==s.status)throw Error("Could not set sleep timeout on duplicated Space. Please visit *ADD HF LINK TO SETTINGS* to set a timeout manually to reduce billing charges.");return await s.json()}catch(e){throw Error(e.message)}}let Y=["cpu-basic","cpu-upgrade","cpu-xl","t4-small","t4-medium","a10g-small","a10g-large","a10g-largex2","a10g-largex4","a100-large","zero-a10g","h100","h100x8"];async function ee(e,t){let s;let{hf_token:n,private:i,hardware:a,timeout:r,auth:o}=t;if(a&&!Y.includes(a))throw Error(`Invalid hardware type provided. Valid types are: ${Y.map(e=>`"${e}"`).join(",")}.`);let{http_protocol:l,host:c}=await D(e,n),u=null;if(o){let e=await $(l,c,o,fetch);e&&(u=j(e))}let d={Authorization:`Bearer ${n}`,"Content-Type":"application/json",...u?{Cookie:u.join("; ")}:{}},p=(await (await fetch("https://huggingface.co/api/whoami-v2",{headers:d})).json()).name,h=e.split("/")[1],f={repository:`${p}/${h}`};i&&(f.private=!0);try{a||(s=await Q(e,n))}catch(e){throw Error(w+e.message)}let g=a||s||"cpu-basic";f.hardware=g;try{let s=await fetch(`https://huggingface.co/api/spaces/${e}/duplicate`,{method:"POST",headers:d,body:JSON.stringify(f)});if(409===s.status)try{return await el.connect(`${p}/${h}`,t)}catch(e){throw console.error("Failed to connect Client instance:",e),e}else if(200!==s.status)throw Error(s.statusText);let i=await s.json();return await X(`${p}/${h}`,r||300,n),await el.connect(function(e){let t=e.match(/https:\/\/huggingface.co\/spaces\/([^/]+\/[^/]+)/);if(t)return t[1]}(i.url),t)}catch(e){throw Error(e)}}class et extends TransformStream{constructor(e={allowCR:!1}){super({transform:(t,s)=>{for(t=l(this,n)+t;;){let n=t.indexOf("\n"),i=e.allowCR?t.indexOf("\r"):-1;if(-1!==i&&i!==t.length-1&&(-1===n||n-1>i)){s.enqueue(t.slice(0,i)),t=t.slice(i+1);continue}if(-1===n)break;let a="\r"===t[n-1]?n-1:n;s.enqueue(t.slice(0,a)),t=t.slice(n+1)}u(this,n,t)},flush:t=>{if(""===l(this,n))return;let s=e.allowCR&&l(this,n).endsWith("\r")?l(this,n).slice(0,-1):l(this,n);t.enqueue(s)}}),c(this,n,"")}}function es(e,t,s){e.get(t)||e.set(t,s)}async function*en(e,t){var s;let n,i,a;if(!e.body)return;let r,o=(s=e.body,i=new TextDecoderStream,a=new et({allowCR:!0}),s.pipeThrough(i).pipeThrough(a)).getReader();for(;;){if(t&&t.aborted)return o.cancel();if((r=await o.read()).done)return;if(!r.value){n&&(yield n),n=void 0;continue}let[e,s]=function(e){let t=/[:]\s*/.exec(e),s=t&&t.index;if(s)return[e.substring(0,s),e.substring(s+t[0].length)]}(r.value)||[];e&&("data"===e?(n||(n={}),n[e]=n[e]?n[e]+"\n"+s:s):"event"===e?(n||(n={}),n[e]=s):"id"===e?(n||(n={}),n[e]=+s||s):"retry"===e&&(n||(n={}),n[e]=+s||void 0))}}async function ei(e,t){let s=new Request(e,t);es(s.headers,"Accept","text/event-stream"),es(s.headers,"Content-Type","application/json");let n=await fetch(s);if(!n.ok)throw n;return en(n,s.signal)}async function ea(){let{event_callbacks:e,unclosed_events:t,pending_stream_messages:s,stream_status:n,config:i,jwt:a}=this,r=this;if(!i)throw Error("Could not resolve app config");n.open=!0;let o=null,l=new URLSearchParams({session_hash:this.session_hash}).toString(),c=new URL(`${i.root}/queue/data?${l}`);if(a&&c.searchParams.set("__sign",a),!(o=this.stream(c))){console.warn("Cannot connect to SSE endpoint: "+c.toString());return}o.onmessage=async function(a){let o=JSON.parse(a.data);if("close_stream"===o.msg){er(n,r.abort_controller);return}let l=o.event_id;if(l){if(e[l]&&i){"process_completed"===o.msg&&["sse","sse_v1","sse_v2","sse_v2.1","sse_v3"].includes(i.protocol)&&t.delete(l);let s=e[l];"undefined"!=typeof window&&"undefined"!=typeof document?setTimeout(s,0,o):s(o)}else s[l]||(s[l]=[]),s[l].push(o)}else await Promise.all(Object.keys(e).map(t=>e[t](o)))},o.onerror=async function(){await Promise.all(Object.keys(e).map(t=>e[t]({msg:"unexpected_error",message:g})))}}function er(e,t){e&&(e.open=!1,null==t||t.abort())}function eo(e,t={},s,n,i){var a;try{let l,c,u,d=function(e){(i||V[e.type])&&_(e)},h=function(){for(X=!0;ee.length>0;)ee.shift()({value:void 0,done:!0})},m=function(e){X||(ee.length>0?ee.shift()(e):Y.push(e))},w=function(e){m({then:(t,s)=>s(e)}),h()},_=function(e){m({value:e,done:!1})},y=function(){return Y.length>0?Promise.resolve(Y.shift()):X?Promise.resolve({value:void 0,done:!0}):new Promise(e=>ee.push(e))},{hf_token:b}=this.options,{fetch:E,app_reference:S,config:$,session_hash:k,api_info:j,api_map:O,stream_status:T,pending_stream_messages:P,pending_diff_streams:N,event_callbacks:z,unclosed_events:A,post_data:x,options:B}=this,L=this;if(!j)throw Error("No API found");if(!$)throw Error("Could not resolve app config");let{fn_index:U,endpoint_info:R,dependency:F}=function(e,t,s,n){let i,a,r;if("number"==typeof t)i=t,a=e.unnamed_endpoints[i],r=n.dependencies.find(e=>e.id==t);else{let o=t.replace(/^\//,"");i=s[o],a=e.named_endpoints[t.trim()],r=n.dependencies.find(e=>e.id==s[o])}if("number"!=typeof i)throw Error("There is no endpoint matching that name of fn_index matching that number.");return{fn_index:i,endpoint_info:a,dependency:r}}(j,e,O,$),J=C(t,R),W=$.protocol??"ws",G="number"==typeof e?"/predict":e,M=null,H=!1,K={},Z="undefined"!=typeof window&&"undefined"!=typeof document?new URLSearchParams(window.location.search).toString():"",V=(null==(a=null==B?void 0:B.events)?void 0:a.reduce((e,t)=>(e[t]=!0,e),{}))||{};async function r(){let e={stage:"complete",queue:!1,time:new Date};H=e,d({...e,type:"status",endpoint:G,fn_index:U});let t={},s={};"ws"===W?(l&&0===l.readyState?l.addEventListener("open",()=>{l.close()}):l.close(),t={fn_index:U,session_hash:k}):(er(T,L.abort_controller),h(),t={event_id:M},s={event_id:M,session_hash:k,fn_index:U});try{if(!$)throw Error("Could not resolve app config");"event_id"in s&&await E(`${$.root}/cancel`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(s)}),await E(`${$.root}/reset`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(t)})}catch(e){console.warn("The `/reset` endpoint could not be called. Subsequent endpoint results may be unreliable.")}}let Q=async e=>{await this._resolve_hearbeat(e)};async function o(e){if(!$)return;let t=e.render_id;$.components=[...$.components.filter(e=>e.props.rendered_in!==t),...e.components],$.dependencies=[...$.dependencies.filter(e=>e.rendered_in!==t),...e.dependencies];let s=$.components.some(e=>"state"===e.type),n=$.dependencies.some(e=>e.targets.some(e=>"unload"===e[1]));$.connect_heartbeat=s||n,await Q($),d({type:"render",data:e,endpoint:G,fn_index:U})}this.handle_blob($.root,J,R).then(async e=>{let t;if(u={data:I(e,F,$.components,"input",!0)||[],event_data:s,fn_index:U,trigger_id:n},t=null==(r=null==(a=null==$?void 0:$.dependencies)?void 0:a.find(e=>e.id==U))?void 0:r.queue,null!=t?t:$.enable_queue){if("ws"==W){let{ws_protocol:e,host:t}=await D(S,b);d({type:"status",stage:"pending",queue:!0,endpoint:G,fn_index:U,time:new Date});let i=new URL(`${e}://${v(t,$.path,!0)}/queue/join${Z?"?"+Z:""}`);this.jwt&&i.searchParams.set("__sign",this.jwt),(l=new WebSocket(i)).onclose=e=>{e.wasClean||d({type:"status",stage:"error",broken:!0,message:g,queue:!0,endpoint:G,fn_index:U,time:new Date})},l.onmessage=function(e){let t=JSON.parse(e.data),{type:i,status:a,data:r}=q(t,K[U]);if("update"===i&&a&&!H)d({type:"status",endpoint:G,fn_index:U,time:new Date,...a}),"error"===a.stage&&l.close();else if("hash"===i){l.send(JSON.stringify({fn_index:U,session_hash:k}));return}else"data"===i?l.send(JSON.stringify({...u,session_hash:k})):"complete"===i?H=a:"log"===i?d({type:"log",log:r.log,level:r.level,endpoint:G,duration:r.duration,visible:r.visible,fn_index:U}):"generating"===i&&d({type:"status",time:new Date,...a,stage:null==a?void 0:a.stage,queue:!0,endpoint:G,fn_index:U});r&&(d({type:"data",time:new Date,data:I(r.data,F,$.components,"output",B.with_null_state),endpoint:G,fn_index:U,event_data:s,trigger_id:n}),H&&(d({type:"status",time:new Date,...H,stage:null==a?void 0:a.stage,queue:!0,endpoint:G,fn_index:U}),l.close()))},0>p($.version||"2.0.0","3.6")&&addEventListener("open",()=>l.send(JSON.stringify({hash:k})))}else if("sse"==W){d({type:"status",stage:"pending",queue:!0,endpoint:G,fn_index:U,time:new Date});var i,a,r,m,w=new URLSearchParams({fn_index:U.toString(),session_hash:k}).toString();let e=new URL(`${$.root}/queue/join?${Z?Z+"&":""}${w}`);if(this.jwt&&e.searchParams.set("__sign",this.jwt),!(c=this.stream(e)))return Promise.reject(Error("Cannot connect to SSE endpoint: "+e.toString()));c.onmessage=async function(e){let t=JSON.parse(e.data),{type:i,status:a,data:r}=q(t,K[U]);if("update"===i&&a&&!H)d({type:"status",endpoint:G,fn_index:U,time:new Date,...a}),"error"===a.stage&&(null==c||c.close(),h());else if("data"===i){M=t.event_id;let[e,s]=await x(`${$.root}/queue/data`,{...u,session_hash:k,event_id:M});200!==s&&(d({type:"status",stage:"error",message:g,queue:!0,endpoint:G,fn_index:U,time:new Date}),null==c||c.close(),h())}else"complete"===i?H=a:"log"===i?d({type:"log",log:r.log,level:r.level,endpoint:G,duration:r.duration,visible:r.visible,fn_index:U}):"generating"===i&&d({type:"status",time:new Date,...a,stage:null==a?void 0:a.stage,queue:!0,endpoint:G,fn_index:U});r&&(d({type:"data",time:new Date,data:I(r.data,F,$.components,"output",B.with_null_state),endpoint:G,fn_index:U,event_data:s,trigger_id:n}),H&&(d({type:"status",time:new Date,...H,stage:null==a?void 0:a.stage,queue:!0,endpoint:G,fn_index:U}),null==c||c.close(),h()))}}else if("sse_v1"==W||"sse_v2"==W||"sse_v2.1"==W||"sse_v3"==W){d({type:"status",stage:"pending",queue:!0,endpoint:G,fn_index:U,time:new Date});let e="";"undefined"!=typeof window&&"undefined"!=typeof document&&(e=null==(i=null==window?void 0:window.location)?void 0:i.hostname);let t=e.includes(".dev.")?`https://moon-${e.split(".")[1]}.dev.spaces.huggingface.tech`:"https://huggingface.co",s="undefined"!=typeof window&&"undefined"!=typeof document&&window.parent!=window,n=F.zerogpu&&$.space_id;(s&&n?(m="zerogpu-headers",new Promise((e,s)=>{let n=new MessageChannel;n.port1.onmessage=({data:t})=>{n.port1.close(),e(t)},window.parent.postMessage(m,t,[n.port2])})):Promise.resolve(null)).then(e=>x(`${$.root}/queue/join?${Z}`,{...u,session_hash:k},e)).then(async([e,t])=>{if(503===t)d({type:"status",stage:"error",message:f,queue:!0,endpoint:G,fn_index:U,time:new Date});else if(200!==t)d({type:"status",stage:"error",message:g,queue:!0,endpoint:G,fn_index:U,time:new Date});else{M=e.event_id;let t=async function(e){try{let{type:s,status:n,data:i}=q(e,K[U]);if("heartbeat"==s)return;if("update"===s&&n&&!H)d({type:"status",endpoint:G,fn_index:U,time:new Date,...n});else if("complete"===s)H=n;else if("unexpected_error"==s)console.error("Unexpected error",null==n?void 0:n.message),d({type:"status",stage:"error",message:(null==n?void 0:n.message)||"An Unexpected Error Occurred!",queue:!0,endpoint:G,fn_index:U,time:new Date});else if("log"===s){d({type:"log",log:i.log,level:i.level,endpoint:G,duration:i.duration,visible:i.visible,fn_index:U});return}else if("generating"===s&&(d({type:"status",time:new Date,...n,stage:null==n?void 0:n.stage,queue:!0,endpoint:G,fn_index:U}),i&&["sse_v2","sse_v2.1","sse_v3"].includes(W))){var t;N[t=M]?i.data.forEach((e,s)=>{var n;let a=(n=N[t][s],e.forEach(([e,t,s])=>{n=function(e,t,s,n){if(0===t.length){if("replace"===s)return n;if("append"===s)return e+n;throw Error(`Unsupported action: ${s}`)}let i=e;for(let e=0;e<t.length-1;e++)i=i[t[e]];let a=t[t.length-1];switch(s){case"replace":i[a]=n;break;case"append":i[a]+=n;break;case"add":Array.isArray(i)?i.splice(Number(a),0,n):i[a]=n;break;case"delete":Array.isArray(i)?i.splice(Number(a),1):delete i[a];break;default:throw Error(`Unknown action: ${s}`)}return e}(n,t,e,s)}),n);N[t][s]=a,i.data[s]=a}):(N[t]=[],i.data.forEach((e,s)=>{N[t][s]=e}))}i&&(d({type:"data",time:new Date,data:I(i.data,F,$.components,"output",B.with_null_state),endpoint:G,fn_index:U}),i.render_config&&await o(i.render_config),H&&(d({type:"status",time:new Date,...H,stage:null==n?void 0:n.stage,queue:!0,endpoint:G,fn_index:U}),h())),((null==n?void 0:n.stage)==="complete"||(null==n?void 0:n.stage)==="error")&&(z[M]&&delete z[M],M in N&&delete N[M])}catch(e){console.error("Unexpected client exception",e),d({type:"status",stage:"error",message:"An Unexpected Error Occurred!",queue:!0,endpoint:G,fn_index:U,time:new Date}),["sse_v2","sse_v2.1","sse_v3"].includes(W)&&(er(T,L.abort_controller),T.open=!1,h())}};M in P&&(P[M].forEach(e=>t(e)),delete P[M]),z[M]=t,A.add(M),T.open||await this.open_stream()}})}}else d({type:"status",endpoint:G,stage:"pending",queue:!1,fn_index:U,time:new Date}),x(`${$.root}/run${G.startsWith("/")?G:`/${G}`}${Z?"?"+Z:""}`,{...u,session_hash:k}).then(([e,t])=>{let i=e.data;200==t?(d({type:"data",endpoint:G,fn_index:U,data:I(i,F,$.components,"output",B.with_null_state),time:new Date,event_data:s,trigger_id:n}),e.render_config&&o(e.render_config),d({type:"status",endpoint:G,fn_index:U,stage:"complete",eta:e.average_duration,queue:!1,time:new Date})):d({type:"status",stage:"error",endpoint:G,fn_index:U,message:e.error,queue:!1,time:new Date})}).catch(e=>{d({type:"status",stage:"error",message:e.message,endpoint:G,fn_index:U,queue:!1,time:new Date})})});let X=!1,Y=[],ee=[],et={[Symbol.asyncIterator]:()=>et,next:y,throw:async e=>(w(e),y()),return:async()=>(h(),y()),cancel:r};return et}catch(e){throw console.error("Submit function encountered an error:",e),e}}n=new WeakMap;class el{constructor(e,t={events:["data"]}){r(this,"app_reference"),r(this,"options"),r(this,"config"),r(this,"api_info"),r(this,"api_map",{}),r(this,"session_hash",Math.random().toString(36).substring(2)),r(this,"jwt",!1),r(this,"last_status",{}),r(this,"cookies",null),r(this,"stream_status",{open:!1}),r(this,"pending_stream_messages",{}),r(this,"pending_diff_streams",{}),r(this,"event_callbacks",{}),r(this,"unclosed_events",new Set),r(this,"heartbeat_event",null),r(this,"abort_controller",null),r(this,"stream_instance",null),r(this,"view_api"),r(this,"upload_files"),r(this,"upload"),r(this,"handle_blob"),r(this,"post_data"),r(this,"submit"),r(this,"predict"),r(this,"open_stream"),r(this,"resolve_config"),r(this,"resolve_cookies"),this.app_reference=e,t.events||(t.events=["data"]),this.options=t,this.view_api=N.bind(this),this.upload_files=z.bind(this),this.handle_blob=R.bind(this),this.post_data=G.bind(this),this.submit=eo.bind(this),this.predict=M.bind(this),this.open_stream=ea.bind(this),this.resolve_config=E.bind(this),this.resolve_cookies=S.bind(this),this.upload=A.bind(this),this.fetch=this.fetch.bind(this),this.handle_space_success=this.handle_space_success.bind(this),this.stream=this.stream.bind(this)}fetch(e,t){let s=new Headers((null==t?void 0:t.headers)||{});return this&&this.cookies&&s.append("Cookie",this.cookies),fetch(e,{...t,headers:s})}stream(e){let t=new Headers;return this&&this.cookies&&t.append("Cookie",this.cookies),this.abort_controller=new AbortController,this.stream_instance=function(e,t={}){let s={close:()=>{console.warn("Method not implemented.")},onerror:null,onmessage:null,onopen:null,readyState:0,url:e.toString(),withCredentials:!1,CONNECTING:0,OPEN:1,CLOSED:2,addEventListener:()=>{throw Error("Method not implemented.")},dispatchEvent:()=>{throw Error("Method not implemented.")},removeEventListener:()=>{throw Error("Method not implemented.")}};return ei(e,t).then(async e=>{s.readyState=s.OPEN;try{for await(let t of e)s.onmessage&&s.onmessage(t);s.readyState=s.CLOSED}catch(e){s.onerror&&s.onerror(e),s.readyState=s.CLOSED}}).catch(e=>{console.error(e),s.onerror&&s.onerror(e),s.readyState=s.CLOSED}),s}(e.toString(),{credentials:"include",headers:t,signal:this.abort_controller.signal}),this.stream_instance}async init(){var e,t;let n;if(("undefined"==typeof window||!("WebSocket"in window))&&!global.WebSocket){let e=await s.e(748).then(s.bind(s,748));global.WebSocket=e.WebSocket}try{this.options.auth&&await this.resolve_cookies(),await this._resolve_config().then(({config:e})=>this._resolve_hearbeat(e))}catch(e){throw Error(e)}this.api_info=await this.view_api(),this.api_map=(t=(null==(e=this.config)?void 0:e.dependencies)||[],n={},t.forEach(({api_name:e,id:t})=>{e&&(n[e]=t)}),n)}async _resolve_hearbeat(e){if(e&&(this.config=e,this.config&&this.config.connect_heartbeat&&this.config.space_id&&this.options.hf_token&&(this.jwt=await b(this.config.space_id,this.options.hf_token,this.cookies))),e.space_id&&this.options.hf_token&&(this.jwt=await b(e.space_id,this.options.hf_token)),this.config&&this.config.connect_heartbeat){let e=new URL(`${this.config.root}/heartbeat/${this.session_hash}`);this.jwt&&e.searchParams.set("__sign",this.jwt),this.heartbeat_event||(this.heartbeat_event=this.stream(e))}}static async connect(e,t={events:["data"]}){let s=new this(e,t);return await s.init(),s}close(){er(this.stream_status,this.abort_controller)}static async duplicate(e,t={events:["data"]}){return ee(e,t)}async _resolve_config(){let e;let{http_protocol:t,host:s,space_id:n}=await D(this.app_reference,this.options.hf_token),{status_callback:i}=this.options;n&&i&&await K(n,i);try{if(!(e=await this.resolve_config(`${t}//${s}`)))throw Error(m);return this.config_success(e)}catch(e){if(n&&i)H(n,O.test(n)?"space_name":"subdomain",this.handle_space_success);else throw i&&i({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),Error(e)}}async config_success(e){if(this.config=e,"undefined"!=typeof window&&"undefined"!=typeof document&&"https:"===window.location.protocol&&(this.config.root=this.config.root.replace("http://","https://")),this.config.auth_required)return this.prepare_return_obj();try{this.api_info=await this.view_api()}catch(e){console.error("Could not get API info. "+e.message)}return this.prepare_return_obj()}async handle_space_success(e){if(!this)throw Error(m);let{status_callback:t}=this.options;if(t&&t(e),"running"===e.status)try{if(this.config=await this._resolve_config(),!this.config)throw Error(m);return await this.config_success(this.config)}catch(e){throw t&&t({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),e}}async component_server(e,t,s){var n;let i,a;if(!this.config)throw Error(m);let r={},{hf_token:o}=this.options,{session_hash:l}=this;o&&(r.Authorization=`Bearer ${this.options.hf_token}`);let c=this.config.components.find(t=>t.id===e);if(i=(null==(n=null==c?void 0:c.props)?void 0:n.root_url)?c.props.root_url:this.config.root,"binary"in s){for(let e in a=new FormData,s.data)"binary"!==e&&a.append(e,s.data[e]);a.set("component_id",e.toString()),a.set("fn_name",t),a.set("session_hash",l)}else a=JSON.stringify({data:s,component_id:e,fn_name:t,session_hash:l}),r["Content-Type"]="application/json";o&&(r.Authorization=`Bearer ${o}`);try{let e=await this.fetch(`${i}/component_server/`,{method:"POST",body:a,headers:r,credentials:"include"});if(!e.ok)throw Error("Could not connect to component server: "+e.statusText);return await e.json()}catch(e){console.warn(e)}}set_cookies(e){this.cookies=j(e).join("; ")}prepare_return_obj(){return{config:this.config,predict:this.predict,submit:this.submit,view_api:this.view_api,component_server:this.component_server}}}}};